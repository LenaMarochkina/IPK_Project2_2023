# IPK Project 2 ZETA: Network sniffer
**Title**: IPK ZETA: Network sniffer\
**Author**: Elena Marochkina\
**Language**: en-US\
**Supported OS**: Linux\
**Gitea**: [xmaroc00_sniffer](https://git.fit.vutbr.cz/xmaroc00/IPK_Project2_2023)

# Table of Contents
1. [Description](#description)
    1. [Compilation](#compilation)
    2. [Usage](#usage)
    3. [Program Details](#program-details)
2. Testing
3. [License](#license)
4. [Bibliography](#bibliography)

## Description

This is a C program that uses the pcap library to capture and analyze network traffic (**a packet sniffer**). 

The program can:
- print the names of available network interfaces
- capture packets based on various criteria, such as protocol type and port number
- print information about captured packets, such as their source and destination 
IP and mac addresses, port numbers, length, time in RFC 3339 format and package contents. 

## Compilation
### Linux
Before using the **sniffer**, you need to compile the **make.c, sniffer.c, filter.c** files.

To compile the program, you can run **make build**, and to remove the ipk-sniffer executable
file, you can run **make clean**.

### Windows
The program can't be compiled for Windows.

## Usage
The client application requires  arguments to run:
- **-i eth0** (just one interface to sniff) or **--interface**. If this parameter is not specified (and any other parameters as well), or if only -i/--interface is specified without a value (and any other parameters are unspecified), a list of active interfaces is printed .
- **-t** or **--tcp** (displays TCP segments and is optionally complemented by -p functionality).
- **-u** or **--udp** (displays UDP datagrams and is optionally complemented by-p functionality).
- **-p 23** (extends previous two parameters to filter TCP/UDP based on port number; if this parameter is not present, then no filtering by port number occurs; if the parameter is given, the given port can occur in both the source and destination part of TCP/UDP headers).
- **--icmp4** (displays only ICMPv4 packets).
- **--icmp6** (displays only ICMPv6 echo request/response).
- **--arp** (display only ARP frames).
- **--ndp** (displays only ICMPv6 NDP packets).
- **--igmp** (displays only IGMP packets).
- **--mld** (displays only MLD packets).
Unless protocols are explicitly specified, all (i.e., all content, regardless of protocol) are considered for printing.
- **-n 10** (specifies the number of packets to display, i.e., the "time" the program runs; if not specified, consider displaying only one packet, i.e., as if -n 1)
All arguments can be in any order.

      Usage: ./ipk-sniffer [-i interface | --interface interface] {-p port [--tcp|-t] [--udp|-u]} [--arp] [--icmp4] [--icmp6] [--igmp] [--mld] {-n num}

## Program Details
### Included libraries
The code uses the following libraries:

- **stdio.h**: Provides basic input/output operations such as printf and scanf.
- **string.h**: Provides functions for manipulating strings such as strcpy and strcat.
- **getopt.h**: Provides functions for parsing command-line arguments.
- **stdbool.h**: Defines the Boolean data type and its possible values.
- **stdlib.h**: Provides functions for memory allocation and manipulation such as malloc and free.
- **ctype.h**: Provides functions for character handling such as isdigit.
- **pcap.h**: Provides functions for capturing and processing network packets.
- **time.h**: Provides functions for working with date and time.
- **net/ethernet.h**: Defines Ethernet packet structures.
- **arpa/inet.h**: Provides functions for working with Internet addresses.
- **sys/socket.h**: Provides functions for working with sockets.

### Global Variables
**err_buf[PCAP_ERRBUF_SIZE]** - err_buf is a character array (i.e., a string) of size
PCAP_ERRBUF_SIZE that is used to store error messages generated by libpcap, a 
library for capturing network traffic.\

### Program Components
1. **Sniffer**

The "sniffer.h" contains multiple helper functions to print information about 
packets captured by a sniffer program.\

**Functions**

**void timeval_to_string(struct timeval time, const char \*format)**

*Input parameters*:

- time: a struct timeval representing the timestamp of the captured packet.
- format: a constant character array representing the format of the timestamp string.

*Output*: none

*Description*: This function converts a struct timeval timestamp to a string format.

**print_ip_and_port()**

*Input parameters*:
- packet: a u_char pointer representing the captured packet.

*Output*: none

*Description*: This function prints the source and destination IP addresses and ports of the captured packet.
- If the protocol of the packet is TCP or UDP, the function extracts the source and destination ports from the packet, and prints them out as well. The function uses bitwise operations to extract the 16-bit port numbers from the packet. The offset values for the source and destination ports depend on whether the packet is IPv4 or IPv6.
- If the Ethernet type of the packet is ARP (Address Resolution Protocol), the function extracts the source and destination IP addresses from the packet and prints them out, without considering any port numbers.

**print_package_data()**

*Input Parameters*:
- data: A pointer to an array of bytes (uint8_t) that contains the package data.
- size: The size of the array (data) in bytes.

*Output*:
This function does not return any value. Instead, it prints the package data in a formatted manner.

*Description*:
The function takes an array of bytes and its size as input and prints the data in a
formatted way to the console, displaying the hexadecimal representation of each byte
as well as its ASCII representation. 

**packet_handler(u_char \*args, const struct pcap_pkthdr \*header, const u_char \*packet)**

*Input Parameters*:
- args: A pointer to the arguments passed to the function.
- header: A pointer to the pcap_pkthdr structure that contains the packet header.
- packet: A pointer to the packet data.

*Output*:
  This function does not return any value. Instead, it prints various information about the packet in a formatted 
manner.

*Description*:
- The function first prints the timestamp of the packet in a formatted manner. 
- Then, it prints the source and destination MAC addresses of the packet. 
- After that, it prints the length of the packet. 
- The function then calls the print_ip_and_port function to print the IP address 
and port of the packet. 
- Finally, the function prints the package data in a formatted manner using the print_package_data function.

2. **Filter**

The "filter.h" header provides functions for creating packet filters using the libpcap library. 
These functions allow the user to specify various criteria, such as protocol type,
port number, and protocol flags, to filter the packets that will be captured.

**Functions**

**void add_protocol(char\* filter_str, const char\* protocol_name, bool* empty)**

*Input parameters*:
- filter_str: a character array representing the filter expression to which the protocol name will be added.
- protocol_name: a constant character array representing the name of the protocol to be added to the filter expression.
- empty: a boolean pointer indicating whether the filter expression is empty or not.

*Output*: none

*Description*: 
This function is a helper function to add a protocol to the filter expression.

**void add_port(char\* filter_str, int port_num, bool\* empty, int tcp_flag, int udp_flag)**

*Input parameters*:
- filter_str: a character array representing the filter expression to which the port number will be added.
- port_num: an integer representing the port number to be added to the filter expression.
- empty: a boolean pointer indicating whether the filter expression is empty or not.
- tcp_flag: an integer indicating whether the TCP flag is set or not.
- udp_flag: an integer indicating whether the UDP flag is set or not.

*Output*: none

*Description*: This function is a helper function to add a port to the filter expression.

**void create_filter_expression(char\* filter_str, int port, int tcp_flag, int udp_flag, int arp_flag, int icmp4_flag, int icmp6_flag, int ndp_flag, int igmp_flag, int mld_flag)**

*Input parameters:*
- filter_str: a character array representing the filter expression to be created.
- port: an integer representing the port number to be added to the filter expression. It can be -1 if the port flag is not set.
- tcp_flag: an integer indicating whether the TCP flag is set or not.
- udp_flag: an integer indicating whether the UDP flag is set or not.
- arp_flag: an integer indicating whether the ARP flag is set or not.
- icmp4_flag: an integer indicating whether the ICMPv4 flag is set or not.
- icmp6_flag: an integer indicating whether the ICMPv6 flag is set or not.
- ndp_flag: an integer indicating whether the NDP flag is set or not.
- igmp_flag: an integer indicating whether the IGMP flag is set or not.
- mld_flag: an integer indicating whether the MLD flag is set or not.

*Output*: none

*Description*: This function creates a filter expression based on the given flags.

3. Main 





## Bibliography
